<!DOCTYPE html>
<html>
  <head>
    <title>Causal Inference for Data Science</title>
    <meta charset="utf-8">
    <meta name="author" content="Mathew Kiang, Zhe Zhang, Monica Alexander" />
    <meta name="date" content="2017-03-15" />
    <link rel="stylesheet" href="custom.css" type="text/css" />
    <link rel="stylesheet" href="../custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Causal Inference for Data Science
## ITAM Short Workshop
### Mathew Kiang, Zhe Zhang, Monica Alexander
### March 15, 2017

---

name: inverse
layout: true
class: center, middle, inverse




---
# Reminder: Omitted Variables

- we rarely "prove" causality
- instead, we argue based on domain expertise and theory that we are not facing biases
- often, a good analysis adjusts a lot of the assumptions to ensure the results are "robust" to possible biases

---
# Reminder: Control Variables To Get CIA

- Conditional Independance Assumption 
- "potential outcomes are random with respect to Treatment status, once we adjust for certain covariates"

We can't always get this argument to be believable though.

???
Some things are quite hard to measure, such as genetic influence, choices for why people move to particular neighborhoods, IQ, motivation, involvement in other related activities

Ultimately, we're often left with omitted variable bias.

---
# Instrumental Variables

- behaviors in the real world that helps encourage a real-world experiment
  - "quasi-experimental" analysis

- by leveraging this information, we can remove the self-selection 

- denote such instruments with `\(z_i\)` variables for each observation `\(i\)`

--
- Different from a control variable. Does not enable conditional independence assumption (CIA).

---
# Instrumental Variables Graphically

![iv_base](./assets/iv_no_issue.png) 
![iv_base](./assets/iv_confound.png)

---
# Instrumental Variables Graphically

![iv_base](./assets/iv_with_z.png)

---
# Instrumental Variable Key

all about "meaningful variation"

- observed variation `\(T_i\)` is not meaningful
  - influenced by unobserved confounders

- can we keep *only* the meaningful, "random" variation in `\(T_i\)`?
  - observed variation = "random/natural" variation + systematic variation from unobservables

--

Answer: use a variable that can predict only the "random" variation in `\(T_i\)`

- Get `\(\hat{T_i} = f(Z_i, X_i)\)` where `\(\hat{T_i} \bot u_i\)`. So `\(\hat{T_i}\)` is only influenced by `\(Z_i\)`. Instead of just `\(T_i\)`.

---
# Exclusion Restriction

`\(Z_i\)` only works if it does NOT look like `\(U_i\)` in the graphic.

- `\(Z_i\)` must be essentially randomly assigned, conditional on other covariates `\(X_i\)`
- it cannot influence the outcome `\(Y_i\)` except through `\(T_i\)`

???
We're not looking at the math here, but we trust that if you get the idea, you can look up a textbook or an online source to clarify the math for why this works.

---
# Key Instrumental Variable Checks

Constant Effect Assumptions:
- Relevance condition / weak instrument?

- "Exclusion restriction" = only one single causal channel

  - could use randomized draft eligibility, unless being draft eligible changes other behaviors
  - could use random weather to instrument for predicting business revenue, unless bad weather affects other environmental aspects (like food supply)
  
Heterogenous Effects Additional Assumption:
- Monotonicity: instrument must have uni-directional effect on treatment status

-- 

*impossible to check!*

---
# How to Use an Instrumental Variable

1. Get `\(\hat{T_i}\)` predicted on the instrument + other covariates. 
  - "First Stage"
  - check for *weak instruments*: usually, look at `\(R^2\)` or version of an F-test
  
2. Predict everyone's treatment status (on/off, treatment amount)
  - "Second Stage" regression 

`$$Y_i = \gamma \hat{T_i}|_{(Z_i,X_i)} + \beta X_i + \epsilon_i$$`

---
# Example: Birthdate as an IV

Angrist, Kreuger 1991; study of school on future earnings

--

```r
library(tidyverse); library(stringr); library(haven)
```

```
## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr
```

```
## Conflicts with tidy packages ----------------------------------------------
```

```
## filter(): dplyr, stats
## lag():    dplyr, stats
```

```r
df &lt;- read_dta('./../datasets/ak_91_iv_qob.dta')
agg_df &lt;- df %&gt;% unite(yob_qob, yob, qob, remove = F) %&gt;%
  group_by(yob_qob) %&gt;%
  summarise(mean_s = mean(s),
            qob = mean(qob),
            yob = mean(yob),
            mean_lnw = mean(lnw))
ggplot(agg_df, aes(x = yob_qob, y = mean_s, group = NA)) + 
  geom_point(aes(color = factor(qob)), size = 3) + 
  geom_line() + geom_label(aes(label = qob,
                               fill = factor(qob))) +
  scale_x_discrete(breaks = agg_df$yob_qob[str_detect(agg_df$yob_qob, "_1")]) +
  ggtitle("Visual for First Stage Relevance")
```

![](lec_4_instrumental_variables_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;

---
# First Stage: Loose Check for Relevance


```r
ggplot(agg_df, aes(x = yob_qob, y = mean_lnw, group = NA)) + 
  geom_point(aes(color = factor(qob)), size = 3) + 
  geom_line() + geom_label(aes(label = qob, 
                               fill = factor(qob))) +
  scale_x_discrete(breaks = agg_df$yob_qob[str_detect(agg_df$yob_qob, "_1")]) +
  ggtitle("Approximate Visual Check for Causal Relevance")
```

![](lec_4_instrumental_variables_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;

---
# Try 2SLS By Hand


```r
library(tidyverse)
df &lt;- read_dta('../datasets/ak_91_iv_qob.dta') %&gt;%
  mutate_at(.funs = as.factor, .cols = c("yob", "sob", "qob")) %&gt;%
  mutate(q4 = ifelse(qob == 4, 1, 0))
# check first stage
no_instrument &lt;- lm(s ~ yob + sob, data = df)
first_stage &lt;- lm(s ~ yob + sob + qob, data = df)
anova(no_instrument, first_stage)
```

---
# Try 2SLS by Hand


```r
# run manual second stage
df &lt;- df %&gt;% mutate(s_hat = predict(first_stage))
second_stage &lt;- lm(lnw ~ s_hat + yob + sob, data = df)
```

---
# Use Built in 2SLS Packages

`ivreg` function from `AER` package


```r
library(AER)
no_iv_reg &lt;- lm(lnw ~ s, data = df)
no_iv_reg_full &lt;- lm(lnw ~ s + yob + sob, data = df)
iv_q4_reg &lt;- ivreg(lnw ~ yob + s | . - s + q4, data = df)
iv_q4_reg_full &lt;- ivreg(lnw ~ yob + sob + s | . - s + q4, data = df)
iv_allQ_reg &lt;- ivreg(lnw ~ yob + sob + s | . - s + qob, data = df)
```


---
# Outputting Regression Results


```r
library(stargazer)
a &lt;- capture.output(
  stargazer(no_iv_reg, no_iv_reg_full, second_stage, 
            iv_q4_reg, iv_q4_reg_full, iv_allQ_reg,
            type = "text", # no.space = T,
            out = "ak91_iv_regs.txt",
            omit = c("sob", "yob"),
            # omit.labels = c("sob", "yob"),
            omit.stat = c("F", "ser"),
            add.lines = list(c("State Fixed Effects?",
                               "No", "Yes", "Yes", 
                               "No", "Yes", "Yes"),
                             c("Instrument", 
                               "None", "QOB", "QOB",
                               "Q4", "Q4", "QOB")))
)
```

---
# More Examples of IV: 

Instruments can take many (creative) forms

- natural experiments
- policy variation
- legal variation (bigger benefits between states)
- geographic/natural aspects (housing location, rivers)
- actions taken by third parties (court systems)

---
# Various Types of Instruments

"good instruments come from a combination of institutional knowledge and ideas about the processes determining the variables of interest" (Angrist &amp; Pischke)

- some ML work to search for instruments

???
Basically, it's not just about data

---
# Is an IV magic?

Any conceptual concerns?

--

We can never "prove" that an IV is valid, it has to be argued

Causality estimate is driven by "meaningful variation"

- an IV may have meaningful RCT variation for a small population

- acknowledge that the true casual effects are usually heterogeneous amongst different groups

*What do you think about the schooling IV?*

---

# Local Average Treatment Effect

IV only estimates a **"Local** Average Treatment Effect"
  - internal vs external (causal) validity
  - a hypothetical measure

---
# LATE Basic Example

Imagine we randomly offer 50% of students a job training program.
- this group is the "intention to treat" (ITT) group
- but only 75% of students accept the Job Training

What do we have?

--
We can do a random experiment measuring the ITT effect.

For the causal effect of job training, we suffer from the self-selection challenge.

--
Instead, we could *also* use the ITT as an instrument for Job Training.

Intuitively, the ITT instrument only has a "local" effect though. 

Why?

---
# LATE Compliers

treated people = {"compliers", "always takers"}

untreated people = {"never takers"}

- *does this matter if treatment effects are constant?*

--
# More on Compliers

Avg Observed Effect of Training = 
Effect on Always Takers + 
Effect on Compliers

- usually, the effect on compliers is the causal effect of interest
  - this is local only to compliers though!

---
# Example of ITT vs Causal Treatment Effect

![iv_itt_effects](./assets/iv_rct_itt_effects_regression.png)

???
On the left is the average Training effect.
It's quite high, because it includes people with unobserved motivation/ambition. Even without the offer of Training, they would've sought out Training anyways.

In the middle is the ITT effect, it's lowered because some people never take.

On the right is the 2SLS, IV estimate of the causal effect of Training. It only captures those who were convinced by the instrument (offer) to join Training.

---
# LATE w/ Potential Outcomes Notation

LATE represents potential outcomes framework

Consider `\(T_{zi}\)` where `\(z \in \left\{ 0, 1 \right\}\)`:

`\(T_{0i}\)` is a person's (potential) treatment choice WITHOUT the instrument
`\(T_{1i}\)` is a person's (potential) treatment choice WITH the instrument

`$$\gamma_{2SLS} = E[Y_{1i} - Y_{0i}|T_{1i} &gt; T_{0i}]$$`

---
# More on LATE

- estimates the avg causal effect for those who are affected by instrument
- must assume that those affected by instrument are affected in the same direction
- *we're skipping lots of math on instruments and standard error calculations*

"IV solves the problem of causal inference in a randomized trial with partial compliance" 
"There is nothing in IV formulas to explain *why* Vietnam-era [military] service affects earnings; for that, you need theory." (Angrist, Pischke)

---

# Characterizing Instruments

Key assumptions around IV cannot be tested. Other aspects can be tested however.
  
- what proportion of our observed treated are "compliers"/"affected" by instrument?

`$$size_{absolute} = E[T_i|Z_i = 1] - E[T_i|Z_i = 0]$$`

`$$P(T_{1i} &gt; T_{0i}|T_i = 1)?$$`

`$$P(T_{1i} &gt; T_{0i}|T_i = 1) = \frac{P(Z_i = 1)\left( E[D_i|Z_i = 1] - E[D_i|Z_i = 0] \right)}{P(D_i = 1)}$$`

`$$P(T_{1i} &gt; T_{0i}|T_i = 1) = \frac{P(Z_i = 1)\left( size_{absolute} \right)}{P(D_i = 1)}$$`
---
# Characterizing Instruments
- what % of our observed treated were affected by `\(IV\)`/$z$?

---
![iv_size_of_compliers](./assets/iv_size_of_compliers.png)

---
# Interpreting IV Characteristics 

- a small group of "compliers"" is not necessarily bad (like only those on the margin of usefulness)

- can also compare the composition of demographic/descriptive variables of the compliers to others

--- 
# Lots more Details on IV

- multiple instruments, interpretation and math of instruments with covariates, IVs for continuous treatment variables

---
# IV Overview

key overall idea: 

look for things in the world/nature/policies that results in some interesting random variation! Finding that is the most difficult part. Once you find it, you can refer to math and textbooks and references to nail the correct interpretation/identification. (product line changes)

- "key source of variation"
- "what's your identification (strategy)"
- be excited but cautious though, there are a lot of ways things can go wrong
  - different functional forms for the instrument
  - lots of statistical subtlety

- overall key advice: always be cautious and recognizing the assumptions that go into causal work. Valuable exercise to think through skeptically.

---
# Weak IV?

Kelibergen-Paap rk Wald F Stat

---
# Regression Discontinuity


---
# Sources

- Cameron &amp; Triveti textbook
- Mostly Harmless Econometrics
- Osea Giuntella, slides
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('showSlide', function (slide) {setTimeout(function() {window.dispatchEvent(new Event('resize'));}, 100)});</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
