---
title: "Causal Inference for Data Science"
subtitle: "ITAM Short Workshop"
author: "Mathew Kiang, Zhe Zhang, Monica Alexander"
date: "March 16, 2017"
output:
  xaringan::moon_reader:
    css: ["custom.css", "./../custom.css", ]
    # In order for the css file to work, you need to set your working directory
    # to one above the slide directory ('./../') and then call moon_reader via
    # `xaringan::inf_mr('./part-01-intro/index.Rmd')`
    # Or just knit it into a browser and it should work immediately.
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
name: inverse
layout: true
class: center, middle, inverse

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

---
# Review So Far

- Emphasis on $\approx$ linear regression
- Much potential bias, specifically OVB
- Conditional indepdence assumption ("controls")
- Instrumental variables can generate (local) meaningful variation to study

This lecture:  
using **repeated** observations and time series to get meaningful variation
idea is simple, execution is trickier

---
# Key Idea

1. with time, there comes "before" and "after"

2. treatment has meaningful variation across places (or times)

???
basically, a carefully thought out version of "*before-and-after*"
comparing trends

---
# Examples of Panel/Longitudinal Data

- neighborhood rent prices over time
- Facebook activity for users over time
- purchasing activity at Amazon or chain store over time
- physical activity measured over time
- government-tracked records over time
- lots of other cool examples... (potentially easier to get access to today)

---
# Fixed Effects

Imagine that we're looking at 50 islands between 1999 - 2010. 

What is the effect of better satellite internet?

--
$$Earnings_it = \alpha + \gamma Usage_{Internet,it} + \beta AvgTemp_i + \beta Beaches_i + \epsilon$$

--
Actually:

$$Earnings_it = \alpha + \gamma Usage_{Internet,it} + F\_Unobserved_i + \epsilon$$

$$Earnings_it = \alpha_i + \gamma Usage_{Internet,it} + \epsilon$$

??
First, we'll look at fixed effects

Idea here is that islands have specific attributes that are hard to capture adequately like history, building, culture, ease of access.

If we argue that these are fixed and how they affect island earnings are constant over time.

---
# FE Concept is General

Can include time and region FE too

$$Earnings_it = \alpha_i + Region_i + Year_t + \gamma Usage_{Internet,it} + \epsilon$$

This is a loose approximation of a time-series model
- capturing overall variation over time or time trends
- capturing general, wider regional trends

---
# Fixed Effects

- unable to observe data on IQ, ability, motivation, parental influence, etc.
- however, we may argue that this is constant over time
- if so, then we can remove this constant using time series data and only look at deviations from that individual-constant

- same thing could be argued for locations, or businesses

**example**: effect of union status on worker wages, using worker specific fixed effects to control for ability (using panel data on worker wages and union status over time)

???
Could be an additive effect or a % effect of union status

---
# Diff-in-Diff

- individual fixed effects are helpful, but not enough

- sometimes "meaningful variation" occurs for a group of individuals (state level, company-wide)
- makes it hard to identify since there are state level unobserved attributes and aspects

**Example**: employees all working for companies in state A receive a higher minimum wage

*What can we estimate here?*

--
- We need to find a control group. Estimate the comparable trend / counterfactual.

---
# Diff-in-Diff Graphically

![mhe_DiD_image](./assets/mhe_DiD_image.png)

---
# DiD Example:

![mhe_DiD_image](./assets/mhe_DiD_table.png)

---
# Brief Math Overview of DiD

Naive (ignores natural differences):

$$Y_{it} = Post_{it} + \beta X_{it} + \epsilon_{it}$$

--

With diff-in-diff:

$$Y_{it} = Post_{t} + \delta TreatedRegion_{i} + \gamma TreatedRegion_{i}\cdot Post_{t} + \beta X_{it}$$

$$Y_{it} = Time_{t} + \delta TreatedRegion_{i} + \gamma TreatedRegion_{i}\cdot Post_{t} + \beta X_{it}$$


??
In the first setup, we control for individual level fixed effects and time fixed effect trends. We look at the post-treatment time period for the treated group.

However, this suffers from the fact that the 

---
# Parallel Trend is a Must

![good_trend](./assets/DiD_gormley_parallel.png)

---
# Parallel Trend is a Must

![good_trend](./assets/DiD_gormley_no_parallel.png)

??
Idea is that you use the non-treated group to estimate the counterfactual estimate

---
# What are conceptual problems with DiD?

--
- non-parallel trend 
  - i.e. local-specific time trends, time shocks
  - "time varying omitted variables"

--  

- group-specific unobserveds? OK
- time-specific unobserveds? OK

- Issue: unobserved variables are correlated with both the self-selection of treatment and the timing of the treatment
  - individual income boost leads to adoption

--
- "avg treatment effect on treated"

--
- what if group fundamentals change as a function of treatment?

---
# DiD Example Discussion 

Bertrand and Mullainathan (2003) looks at state-by-state differences in rules surrounding mergers & acquisitions.

DiD = wage differences across states pre-law change and post-law change.

1. Laws were changing when wages were growing nationally

2. States that choose to change regulation had more unions.

??
Unions have higher wages, so this is accounted for in time-invariant differences

Unions have may time-varying trends though, so some self-selection in treatment here.

---
# Improve on the Simple Diff-in-Diff Idea

Relative time indicators

--
- allows the use of variable post-treatment time periods
- allows the estimation of dynamic treatment effects
- reduces risk of time-varying omitted variables

![relative_time](./assets/DiD_nagaraj_relative_time.png)

---
# Improve on the Simple Diff-in-Diff Idea

Use matching to limit the control group:
  - synthetically enforce parallel trends before treatment

---
# Improve on the Simple Diff-in-Diff Idea

Dig more into the argued causal mechanisms
- show that effect is stronger for groups where the theory says it should
  - e.g., types of companies across states
  - e.g., categories of purchases across companies

**falsification tests**
- broader, general idea
- pretend that treatment occurs in treated groups before actual treatment. Do we estimate an effect when it should not be there?

---
# Private Impact of Public Maps

[todo, go in-depth into Nagaraj reading, emphasize the robustness]

---
# Hands-On With DiD Data

[todo, find a dataset to use]

---
# Regression Discontinuity Designs

- similar in flavor to IV, diff-in-diff

---
# Emphasis on General Meaningful Variation

- Turo changes a product, looking at geographic diffusion

- Scientists do experiment design. 
- Observational causal inference people do experiment design afterwards.

---
# PSM (if there's room)

---
# Sources

- Mostly Harmless Econometrics
- Osea Giuntella, slides
- Todd Gormley, slides