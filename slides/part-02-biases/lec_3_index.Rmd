---
title: "Causal Inference for Data Science"
subtitle: "ITAM Short Workshop"
author: "Mathew Kiang, Zhe Zhang, Monica Alexander"
date: "March 14, 2017"
output:
  xaringan::moon_reader:
    css: ["custom.css", "./../custom.css", ]
    # In order for the css file to work, you need to set your working directory
    # to one above the slide directory ('./../') and then call moon_reader via
    # `xaringan::inf_mr('./part-01-intro/index.Rmd')`
    # Or just knit it into a browser and it should work immediately.
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
name: inverse
layout: true
class: center, middle, inverse

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

---

# Biases in Observational Data

???

(almost) All data is observational.

If you think you have an experiment, it's probably still observational data.

---

# Roadmap

4 major types of bias:
- omitted variable confounding
- selection
- truncation/censored variables
- choice of regression error term

---
layout: false
.left-column[
  ## Roadmap
  ### Omitted Variable Confounding
]
.right-column[
<br><br><br>
- most common occurrence in analysis, i.e. OVB
- up to analyst to decide if OVB affects insights
- occurs when omitted variable affects both the outcome and a predictor
]

---
layout: false
.left-column[
  ## Roadmap
  ### Omitted Variable Confounding
]
.right-column[
- most common occurrence in analysis, i.e. OVB
- up to analyst to decide if OVB affects insights
- occurs when omitted variable affects both the outcome and a predictor
![Wired Article](./assets/dag_ovb_simple.png)
]

---
layout: false
.left-column[
  ## Roadmap
  ### Omitted Variable Confounding
  #### Examples
]
.right-column[
```{r}
library(tidyverse)
df_educ <- data_frame(iq = runif(200, 1, 100),
                      school_years = 16 - 0.05*iq + rnorm(200),
                      income = 20000 + 5000*school_years + 5000*rnorm(200) + 500*iq)
summary(lm(income ~ school_years, data = df_educ))
summary(lm(income ~ school_years + iq, data = df_educ))
```

]


---
layout: false
.left-column[
  ## Roadmap
  ### Omitted Variable Confounding
  #### Academic Examples
]
.right-column[
- job training programs [cite] [todo]
- [todo]
]

---
layout: false
.left-column[
  ## Roadmap
  ### Omitted Variable Confounding
  #### Data Science Examples
]
.right-column[
- advertising tracking
]


---
layout: false
.left-column[
  ## Roadmap
  ### Workshop
  ### Today
]
.right-column[
<br><br>
- **Introduction to Causal Inference**. Establish a framework we can all use.
]
???
So for today, we're going to do four talks. First, we're going to make sure we are all on the same page about what causal inference is. **NEXT SLIDE**

Second, within this framework, let's talk about estimating a causal effect in a best case scenario. **NEXT SLIDE**

Third, we'll talk about different obstacles to estimating causal effects. In the real world setting a randomized control trial is often not feasible or ethical so what can we do to ensure we aren't breaking the assumptions of our framework? **NEXT SLIDE**

And then we'll introduce a method to overcome some of these obstacles called instrumental variables and talk about how it attempts to mimic an RCT.
--
.right-column[
- **Estimating Causal Effects.** Within this framework, how do we estimate a "causal effect" in the ideal case — a randomized control trial.
]
--
.right-column[
- **Obstacles to Estimation.** In the real world, we have a variety of biases. What do we do?
]
--
.right-column[
- **Instrumental variables.** First example of overcoming biases and how IV relates to our ideal case.
]

---
layout: false
.left-column[
  ## Roadmap
  ### Workshop
  ### Today
  ### Now
]
.right-column[
<br><br>
- **Motivation.** Why do we care about causal inference at all?
]
--
.right-column[
- **Definition.** What is a causal effect? What is causal inference? 
]
--
.right-column[
- **Rubin causal model.** A framework for evaluating causality
]

---
template: inverse

## Motivation
### Why do we care about causal inference at all?
???
So why do we even care about causal inference? Obviously, you guys care because you're here, but why should data scientists in general care about causal inference? 

---
# Almost all questions we are interested in are *causal*

???
Well, the simple answer is that most of the questions we are interested in are causal questions. 

Yet our tools are correlation based.

--

1. What is the effect of Drug B on the population?

1. How will increasing minimum wage affect the employment rate?

1. Do unconditional cash transfer programs help relieve poverty?

1. Will stricter gun laws reduce gun-related homocide?

--

# Yet almost all our tools for to answer these questions are based on *correlation*..red[*]

.footnote[.red[*]Big data does not fix this.]

---
layout: false
.left-column[
  ## Motivation

"Scientists are trained to recognize that correlation is not causation, that no conclusions should be drawn simply on the basis of correlation between X and Y (it could just be a coincidence)."
]
.right-column[
<br><br><br>
![Wired Article](./assets/wired_article.png)
]
???
This is an article from Wired Magazine and it has a bit of the sentiment we see a lot now.

---
layout: false
.left-column[
  ## Motivation
"There is now a better way. Petabytes allow us to say: 'Correlation is enough.'"
]
.right-column[
<br><br><br>
![Wired Article](./assets/wired_article.png)
]
???
Obviously, we disagree. Hopefully, you do too and that's why you're here.

---
layout: false
.footnote[Blake, T., Nosko, C. and Tadelis, S. (2015)]
.left-column[
  ## Motivation
  ### Causal Inference Gone Bad
]
.right-column[
<br><br>
## eBay example
Does an increase in spending on keyword advertisements increase my return?
]
--
.right-column[
Prior: Targeted internet advertising is highly effective (you get people who are interested in your product)
]
--
.right-column[
Predictive models indicate ad clicks translates to increased success
]

---
layout: false
.footnote[Blake, T., Nosko, C. and Tadelis, S. (2015)]
.left-column[
  ## Motivation
  ### Causal Inference Gone Bad
]
.right-column[
<br><br>
## eBay example
Causal question: **Compared to not increasing ad revenue**, how much does an increase in ad revenue affect my return?
]
--
.right-column[
Design: Stop advertising on two search engines, but continue on one.
]
--
.right-column[
Results: Almost everybody found the site through unpaid search traffic. (Other studies show the returns to be *negative*)
]
---
layout: false
.footnote[e.g., Hernán et al. Epidemiology (2008)]
.left-column[
  ## Motivation
  ### Causal Inference Gone Bad
]
.right-column[
<br><br>
## Hormone replacement therapy
By 1990's, HRT was incredily popular medication for women.
]
--
.right-column[
All observation studies, including Nurses' Health Study, indicated HRT lowered risk of CVD by about 35-45%.
]
--
.right-column[
Then, two RCTs (HERS and WHI) found HRT actually **increased** risk of CVD.
]
---
layout: false
.footnote[e.g., Hernán et al. Epidemiology (2008)]
.left-column[
  ## Motivation
  ### Causal Inference Gone Bad
]
.right-column[
<br><br>
## Hormone replacement therapy
Increased risk by about 25%, putting lots of lives at risk. 
]
--
.right-column[
In retrospect, lots of errors and biases that were unaccounted in observational studies. Caused a large (and often vitriolic) debate in public health.
]
--
.right-column[
On the plus side, see Hernan et al. 2008 for how sophisticated analyses (and domain-specific knowledge) would have resulted in correct conclusions.
]
---
layout: false
.left-column[
  ## Motivation
  ### Causal Inference Gone Bad
  ### Causal Inference Done Right
]
.right-column[
<br><br>
## TODO
We need one good example here.
]


---
template: inverse

## Definition
### What is causal inference?
---
class: center, middle
# Causal inference is the process of estimating a comparison of potential outcomes under different treatment conditions on the same set of units.
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
]
.right-column[
# What is a causal effect?
]
--
.right-column[
If Edward takes Drug B and get a headache, did Drug B *cause* his headache?
]

???
What do we mean when we say something *caused* something else? We intuitively understand but what do we mean explicitly? 

Let's pretend I take a Drug and I get a headache. Did the Drug cause my headache?

It only caused my headache if we knew I wouldn't have gotten the headache, had I not taken the drug.
--
.right-column[
Implicitly, Drug B only caused the headache if Eddie would *not* have received the headache if Eddie had not taken Drug B.
]
--
.right-column[
So a causal effect is a comparison of two *potential outcomes* (or *counterfactuals*) on a unit (or a single set of units). Importantly, we only observe **one** outcome so all comparisons are hypothetical. 
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
# Counterfactuals
]
.right-column[
So, we define our counterfactuals: 
- Let $A$ be a binary treatment with $1$ indicating the drug is taken and $0$ otherwise
- $Y^{a=0}$ is the outcome if Eddie had *not* taken the drug 
- $Y^{a=1}$ is the outcome if Eddie *had* taken the drug
]
???
So let's formalize this with a little bit of notation.

Some people prefer **potential outcomes** to emphasize that two different outcomes could potentially be observed depending on the treatment while others prefer **counterfactuals** to emphasize that each outcome represents situations that may not actually occur.
--
.right-column[
Then, Drug B has a causal effect if and only if $Y^{a=0}\neq Y^{a=1}$
]
--
.right-column[
The *__individual__ causal effect* of Drug B then is $ICE=Y^{a=1} - Y^{a=0}$
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
# Data we **_want_**
### "God's Data"

| Name  | $Y^{a=0}$ | $Y^{a=1}$ |
|-------|:---------:|:---------:|
| Eddie |       1   |       1   |
| Marla |       1   |       0   |
| Bob   |       0   |       0   |
| ...   |     ...   |     ...   |
| Tyler |       1   |       0   |
]
--
.right-column[
This is not possible in reality. For example, even if we use the same person but at different times, we cannot consider it to be the same unit.
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
# Data we **_have_**
### The Fundamental Problem of Causal Inference

| Name  | $Y^{a=0}$ | $Y^{a=1}$ |
|-------|:---------:|:---------:|
| Eddie |    _?_    |       1   |
| Marla |    _?_    |       0   |
| Bob   |       0   |     _?_   |
| ...   |     ...   |     ...   |
| Tyler |       1   |   _?_     |
]
--
.right-column[
For each individual, we only observe one of the potential outcomes — thus, individual causal effects cannot be estimated
]
---
class: center, middle
# Causal inference is a missing data problem
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
### The Fundamental Problem of Causal Inference

| Name  | $Y^{a=0}$ | $Y^{a=1}$ | $A$ | $Y$ |
|-------|:---------:|:---------:|:---:|:---:|
| Eddie |    _?_    |       1   |  1  |  1  |
| Marla |    _?_    |       0   |  1  |  0  |
| Bob   |       0   |   _?_     |  0  |  0  |
| ...   |     ...   |     ...   | ... | ... |
| Tyler |       1   |   _?_     |  0  |  1  |
]
--
.right-column[
If we had "God's Data", the _**average treatment effect**_ would be $ATE=Pr(Y^{a=1})-Pr(Y^{a=0})$
]
--
.right-column[
Under what conditions do the data we have properly estimate the data we want? That is, when does $Pr(Y^{a=1})-Pr(Y^{a=0})=Pr(Y|A=1)-Pr(Y|A=0)$
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
## Assumptions

- **Exchangeability**. $Y^a \perp A$ for all values of $a$. Often also called ignorability, exogenieity, no unmeasured confounders, selection on observables, randomization, etc. 
]
--
.right-column[
- **Positivity**. Every unit has a positive probability of having any value of $a$.
]
--
.right-column[
- **Stable unit treatment value assumption (SUTVA)**. Two things. First, treatment and control are stable — there's only one form of each. Second, the assignment of one unit does not affect the outcome of another.
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
## Exchangeability 

| Name  | $Y^{a=0}$ | $Y^{a=1}$ | $A$ | $Y$ |
|-------|:---------:|:---------:|:---:|:---:|
| Eddie |    _?_    |       1   |  1  |  1  |
| Marla |    _?_    |       0   |  1  |  0  |
| Bob   |       0   |   _?_     |  0  |  0  |
| ...   |     ...   |     ...   | ... | ... |
| Tyler |       1   |   _?_     |  0  |  1  |

- If each person's assignment $A$ is independent of their observed outcome $Y$, then we call the groups $A=1$ and $A=0$ "exchangeable". 
]
--
.right-column[
- This is **only** ensured when the mechanism of assignment $A$ is random. Otherwise, we try to make this as reasonable as possible, but can never confirm it to be true. 
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
## Positivity 

| Name  | $Y^{a=0}$ | $Y^{a=1}$ | $A$ | $Y$ |
|-------|:---------:|:---------:|:---:|:---:|
| Eddie |    _?_    |       1   |  1  |  1  |
| Marla |    _?_    |       0   |  1  |  0  |
| Bob   |       0   |   _?_     |  0  |  0  |
| ...   |     ...   |     ...   | ... | ... |
| Tyler |       1   |   _?_     |  0  |  1  |

- Every person has to have a non-zero probability of being in any level of $A$.
]
--
.right-column[
- If we treated everybody ($A=1$), we would not be able to estimate a causal effect.
]
---
layout: false
.left-column[
  ## Causal Inference
  ### Causal effect
  ### Rubin causal model
]
.right-column[
## Stability (SUTVA) 

| Name  | $Y^{a=0}$ | $Y^{a=1}$ | $A$ | $Y$ |
|-------|:---------:|:---------:|:---:|:---:|
| Eddie |    _?_    |       1   |  1  |  1  |
| Marla |    _?_    |       0   |  1  |  0  |
| Bob   |       0   |   _?_     |  0  |  0  |
| ...   |     ...   |     ...   | ... | ... |
| Tyler |       1   |   _?_     |  0  |  1  |

- We need a stable treatment (150mg of Advil) and stable control (no Advil). We cannot estimate a causal effect if we have varying doses of Advil within levels of $A$.
]
--
.right-column[
- One person taking Advil should not affect the outcome of another person.
]
---
# Caveat about Rubin Causal Model

- Despite how it will feel when reading the literature, this is **not the only framework** of causal inference. 

--

- It is a very useful framework. But also limited — especially when evaluating things with no well-defined intervention. (For example, "Does obesity increase the risk of premature mortality?")

--

- Still an active debate. For an example, see debate in epidemiology between Nancy Krieger.red[*] et al. and Jamie Robins et al.

---
class: center, middle
# Thanks!

---
# Sources

- [Wired Article](https://www.wired.com/2008/06/pb-theory/): https://www.wired.com/2008/06/pb-theory/
- [eBay example](http://onlinelibrary.wiley.com/doi/10.3982/ECTA12423/abstract) - Blake, T., Nosko, C. and Tadelis, S. (2015), Consumer Heterogeneity and Paid Search Effectiveness: A Large-Scale Field Experiment. Econometrica, 83: 155–174. doi:10.3982/ECTA12423
- [Jennifer Hill talk](http://cds.nyu.edu/wp-content/uploads/2014/04/causal-and-data-science-and-BART.pdf)
- [Hormone replacement therapy](https://cdn1.sph.harvard.edu/wp-content/uploads/sites/1268/2014/11/Authors__Response_Part_I__Observational_Studies.6.pdf) - Hernán MA, Alonso A, Logan R, Grodstein F, Michels KB, Willett WC, Manson JE, Robins JM. Observational studies analyzed like randomized experiments: an application to postmenopausal hormone therapy and coronary heart disease (with discussion). Epidemiology 2008; 19:766-779
- [Causal inference book](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/) by Miguel Hernan and Jamie Robins (free)
- [Causality chapter](http://www.ics.uci.edu/~sternh/courses/265/imbensrubin1.pdf) by Imbens and Rubin

---
# Additional Reading
- [We are all data scientists now](https://stanford.edu/~jgrimmer/bd_2.pdf) - Grimer 2015 (doi:10.1017/S1049096514001784)
- [More about HRT controvery](http://www.teachepi.org/documents/courses/bfiles/The%20B%20Files_File1_HRT_Final_Complete.pdf)
- [Basic Concepts of Statistical Inference for Causal Effects](http://www.stat.columbia.edu/~cook/qr33.pdf) from Rubin himself
